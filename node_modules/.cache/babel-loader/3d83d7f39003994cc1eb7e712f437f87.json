{"ast":null,"code":"'use strict';\n\nvar figgyPudding = require('figgy-pudding');\n\nvar index = require('./lib/entry-index');\n\nvar memo = require('./lib/memoization');\n\nvar write = require('./lib/content/write');\n\nvar to = require('mississippi').to;\n\nvar PutOpts = figgyPudding({\n  algorithms: {\n    \"default\": ['sha512']\n  },\n  integrity: {},\n  memoize: {},\n  metadata: {},\n  pickAlgorithm: {},\n  size: {},\n  tmpPrefix: {},\n  single: {},\n  sep: {},\n  error: {},\n  strict: {}\n});\nmodule.exports = putData;\n\nfunction putData(cache, key, data, opts) {\n  opts = PutOpts(opts);\n  return write(cache, data, opts).then(function (res) {\n    return index.insert(cache, key, res.integrity, opts.concat({\n      size: res.size\n    })).then(function (entry) {\n      if (opts.memoize) {\n        memo.put(cache, entry, data, opts);\n      }\n\n      return res.integrity;\n    });\n  });\n}\n\nmodule.exports.stream = putStream;\n\nfunction putStream(cache, key, opts) {\n  opts = PutOpts(opts);\n  var integrity;\n  var size;\n  var contentStream = write.stream(cache, opts).on('integrity', function (_int) {\n    integrity = _int;\n  }).on('size', function (s) {\n    size = s;\n  });\n  var memoData;\n  var memoTotal = 0;\n  var stream = to(function (chunk, enc, cb) {\n    contentStream.write(chunk, enc, function () {\n      if (opts.memoize) {\n        if (!memoData) {\n          memoData = [];\n        }\n\n        memoData.push(chunk);\n        memoTotal += chunk.length;\n      }\n\n      cb();\n    });\n  }, function (cb) {\n    contentStream.end(function () {\n      index.insert(cache, key, integrity, opts.concat({\n        size: size\n      })).then(function (entry) {\n        if (opts.memoize) {\n          memo.put(cache, entry, Buffer.concat(memoData, memoTotal), opts);\n        }\n\n        stream.emit('integrity', integrity);\n        cb();\n      });\n    });\n  });\n  var erred = false;\n  stream.once('error', function (err) {\n    if (erred) {\n      return;\n    }\n\n    erred = true;\n    contentStream.emit('error', err);\n  });\n  contentStream.once('error', function (err) {\n    if (erred) {\n      return;\n    }\n\n    erred = true;\n    stream.emit('error', err);\n  });\n  return stream;\n}","map":null,"metadata":{},"sourceType":"module"}