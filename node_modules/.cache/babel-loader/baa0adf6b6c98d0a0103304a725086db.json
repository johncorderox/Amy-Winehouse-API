{"ast":null,"code":"var eos = require('end-of-stream');\n\nvar shift = require('stream-shift');\n\nmodule.exports = each;\n\nfunction each(stream, fn, cb) {\n  var want = true;\n  var error = null;\n  var ended = false;\n  var running = false;\n  var calling = false;\n  stream.on('readable', onreadable);\n  onreadable();\n  if (cb) eos(stream, {\n    readable: true,\n    writable: false\n  }, done);\n  return stream;\n\n  function done(err) {\n    if (!error) error = err;\n    ended = true;\n    if (!running) cb(error);\n  }\n\n  function onreadable() {\n    if (want) read();\n  }\n\n  function afterRead(err) {\n    running = false;\n\n    if (err) {\n      error = err;\n      if (ended) return cb(error);\n      stream.destroy(err);\n      return;\n    }\n\n    if (ended) return cb(error);\n    if (!calling) read();\n  }\n\n  function read() {\n    while (!running && !ended) {\n      want = false;\n      var data = shift(stream);\n      if (ended) return;\n\n      if (data === null) {\n        want = true;\n        return;\n      }\n\n      running = true;\n      calling = true;\n      fn(data, afterRead);\n      calling = false;\n    }\n  }\n}","map":null,"metadata":{},"sourceType":"module"}